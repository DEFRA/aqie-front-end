{% extends 'layouts/page.njk' %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}
{% set caption = "" %}
{% set pollutantTime = '' %}
{% set pollutantDay = '' %}
{% set pollutantMonth = '' %}
{% set pollutantYear = '' %}
{% set pageHeadingSize = pageHeadingSize or "xl govuk-!-margin-top-4" %}
{# '' #}
{% block content %}
{% if lang == "en" %}
{% set htmlLang = "en" %}
{% else %}
{% set htmlLang = "cy" %}
{% endif %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds-from-desktop govuk-grid-column-full">
      <h1 class="govuk-heading-{{ pageHeadingSize }}">
{% if caption %}
        <span class="govuk-caption-{{ pageHeadingSize }}">{{ caption }}</span>
{% endif %}
        {{ title }}
      </h1>
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full-until-desktop govuk-grid-column-two-thirds-from-desktop">
  
  {# Display warning for high or very high pollution forecasts #}
  {% if forecastWarning %}
    {{ govukWarningText({
      text: forecastWarning.text,
      iconFallbackText: "Warning"
    }) }}
  {% endif %}

  {% include "daqi-numbered.njk" %}
      
      {# '' Display summary date only if it's today's date #}
      {% if showSummaryDate and summaryDate %}
        <p class="govuk-caption-s daqi-health-summary-date">{{ daqi.pageTexts.b }} {{ issueTime | default('5:00') }} {{ daqi.pageTexts.on }} {{ summaryDate }}</p>
        <hr class="govuk-section-break govuk-section-break--visible govuk-section-break--l govuk-!-margin-bottom-6" data-daqi-tabs-separator>
      {% endif %}

      {# '' Convert value to integer for comparison to ensure mockLevel works correctly #}
      {% set todayValue = airQuality.today.value | int %}
      {# '' AQC-657: Exposure section ordering: show first ONLY for Low (1-3) levels #}
      {% if todayValue <= 3 %}
        {# '' Set variable to add top margin when summary date not shown #}
        {% set needsTopMargin = not (showSummaryDate and summaryDate) %}
        {% include "exposure-section.njk" %}
        {# '' AQC-657: Visual separator between exposure advice and health advice (Low level order) #}
        <hr data-daqi-separator="between-health-exposure" class="govuk-section-break govuk-section-break--visible govuk-!-margin-top-6 govuk-!-margin-bottom-6">
      {% endif %}
      <h2 class="govuk-heading-m{% if not (showSummaryDate and summaryDate) %} govuk-!-margin-top-6{% endif %}">{{ daqi.healthAdvice.paragraphs.a }} {{ airQuality.today.readableBand }} {{ daqi.healthAdvice.paragraphs.b }}</h2>
      
      {# '' For Low levels (1-3): show advice paragraph + regular text content without inset box #}
      {% if todayValue <= 3 %}
        <p>{{ airQuality.today.advice }}</p>
        {# '' Replace {locationId} placeholder and add query parameters for proper back link context #}
        {% set processedInsetText = airQuality.today.insetText | replace('{locationId}', locationId) %}
        {% set queryParams = '' %}
        {% if searchTerms %}
          {% set queryParams = queryParams + '&searchTerms=' + (searchTerms | urlencode) %}
        {% endif %}
        {% if locationName %}
          {% set queryParams = queryParams + '&locationName=' + (locationName | urlencode) %}
        {% endif %}
        {% if queryParams %}
          {% if lang == 'en' %}
            {% set processedInsetText = processedInsetText | replace('actions-reduce-exposure?lang=en', 'actions-reduce-exposure?lang=en' + queryParams) %}
            {% set processedInsetText = processedInsetText | replace('health-effects?lang=en', 'health-effects?lang=en' + queryParams) %}
          {% elif lang == 'cy' %}
            {% set processedInsetText = processedInsetText | replace('camau-lleihau-amlygiad/cy?lang=cy', 'camau-lleihau-amlygiad/cy?lang=cy' + queryParams) %}
            {% set processedInsetText = processedInsetText | replace('effeithiau-iechyd?lang=cy', 'effeithiau-iechyd?lang=cy' + queryParams) %}
          {% endif %}
        {% endif %}
        <div class="daqi-health-content daqi-health-content--low" data-daqi-band="low">
          {{ processedInsetText | safe }}
        </div>
      {% else %}
        {# '' For Moderate+ levels (4-10): advice is included in inset text, show colored inset text box only #}
        {# '' Replace {locationId} placeholder and add query parameters for proper back link context #}
        {% set processedInsetText = airQuality.today.insetText | replace('{locationId}', locationId) %}
        {% set queryParams = '' %}
        {% if searchTerms %}
          {% set queryParams = queryParams + '&searchTerms=' + (searchTerms | urlencode) %}
        {% endif %}
        {% if locationName %}
          {% set queryParams = queryParams + '&locationName=' + (locationName | urlencode) %}
        {% endif %}
        {% if queryParams %}
          {% if lang == 'en' %}
            {% set processedInsetText = processedInsetText | replace('actions-reduce-exposure?lang=en', 'actions-reduce-exposure?lang=en' + queryParams) %}
            {% set processedInsetText = processedInsetText | replace('health-effects?lang=en', 'health-effects?lang=en' + queryParams) %}
          {% elif lang == 'cy' %}
            {% set processedInsetText = processedInsetText | replace('camau-lleihau-amlygiad/cy?lang=cy', 'camau-lleihau-amlygiad/cy?lang=cy' + queryParams) %}
            {% set processedInsetText = processedInsetText | replace('effeithiau-iechyd?lang=cy', 'effeithiau-iechyd?lang=cy' + queryParams) %}
          {% endif %}
        {% endif %}
        {{ govukInsetText({
          html: processedInsetText,
          classes: 'daqi-health-inset daqi-health-inset--' + airQuality.today.band,
          attributes: {
            'data-daqi-band': airQuality.today.band
          }
        }) }}
      {% endif %}
      {# '' AQC-657: For Moderate+ (4-10) levels show exposure section after health advice block #}
      {% if todayValue > 3 %}
        {# '' AQC-657: Visual separator before exposure section for Moderate+ levels #}
        <hr data-daqi-separator="between-health-exposure" class="govuk-section-break govuk-section-break--visible govuk-!-margin-top-6 govuk-!-margin-bottom-6">
        {% include "exposure-section.njk" %}
      {% endif %}
      {% if lang == "en" %}
      {% include "daqi-index.njk" %}
      {% endif %}
      {% if lang == "cy" %}
      {% include "daqi-index-welsh.njk" %}
      {% endif %}

      <hr class="govuk-section-break govuk-section-break--visible govuk-!-margin-bottom-6">
      <h2 class="govuk-heading-m">{{ daqi.pageTexts.c }}</h2>
      {% include "pollutants.njk" %}
{% if monitoringSites|length %}
<hr class="govuk-section-break govuk-section-break--visible govuk-!-margin-bottom-6 govuk-!-margin-top-6">
<h2 class="govuk-heading-m">{{ daqi.pageTexts.d }}</h2>
<p>{{ daqi.tooltipText.latest1 | safe }}<span class='govuk-!-font-size-16 govuk-!-font-weight-regular'><sup>3</sup></span>{{ daqi.tooltipText.latest2 | safe }}</p>
{% endif %}
{% set tabs = [] %} {# Initialize an array to store tab items dynamically #}
{% for site in monitoringSites %}
 {% set rows = [] %} {# Initialize rows for the current site #}
{% set time %}
    {{ "now" | date | minusOneHour }}
{% endset %}

{% set measurementToggletip %}
{% set microgramcubic = daqi.tooltipText.latest %}
{% endset %}

{% set levelToggletip %}
{% endset %}

{% set siteNameToggletip %}
{% endset %}

  {% set rows = [] %}

  {% for key, pollutantDetail in pollutantTypes %}
   {% set pollutant = site.pollutants[key] %}
    {% if pollutant %}
      {# Defensive assignments for pollutant time fields #}
      {% if pollutant.time and pollutant.time.hour is defined %}
        {% set pollutantTime = pollutant.time.hour %}
      {% else %}
        {% set pollutantTime = '' %}
      {% endif %}
      {% if pollutant.time and pollutant.time.day is defined %}
        {% set pollutantDay = pollutant.time.day %}
      {% else %}
        {% set pollutantDay = '' %}
      {% endif %}
      {% if pollutant.time and pollutant.time.month is defined %}
        {% set pollutantMonth = pollutant.time.month %}
      {% else %}
        {% set pollutantMonth = '' %}
      {% endif %}
      {% if pollutant.time and pollutant.time.year is defined %}
        {% set pollutantYear = pollutant.time.year %}
      {% else %}
        {% set pollutantYear = '' %}
      {% endif %}
      {# Defensive assignments for pollutant values #}
      {% set pollutantHref = pollutantDetail.href or '#' %}
      {# '' Add query parameters for back link context #}
      {% if pollutantHref != '#' %}
        {% set pollutantHref = pollutantHref + '?lang=' + lang %}
        {% if locationId %}
          {% set pollutantHref = pollutantHref + '&locationId=' + locationId %}
          {% if locationName %}
            {% set pollutantHref = pollutantHref + '&locationName=' + (locationName | urlencode) %}
          {% endif %}
          {% if searchTerms %}
            {% set pollutantHref = pollutantHref + '&searchTerms=' + (searchTerms | urlencode) %}
          {% endif %}
        {% endif %}
      {% endif %}
      {% set pollutantTitle = pollutantDetail.title or '' %}
      {% set pollutantLowRange = pollutantDetail.low_range or '' %}
      {% if pollutant.value is defined %}
        {% set pollutantValue = "<span class=\"govuk-!-font-weight-bold\">" ~ pollutant.value ~ "</span>" | safe %}
      {% else %}
        {% set pollutantValue = '' %}
      {% endif %}
      {% if pollutant.daqi is defined %}
        {% set pollutantDaqi = pollutant.daqi %}
      {% else %}
        {% set pollutantDaqi = 'default-aqi-value' %}
      {% endif %}
      {% if pollutant.band is defined %}
        {% set pollutantBand = pollutant.band %}
        {# '' - Normalize band for CSS class (handles both English and Welsh band names) #}
        {% set pollutantBandClass = pollutant.band | normalizeBandClass %}
      {% else %}
        {% set pollutantBand = '' %}
        {% set pollutantBandClass = '' %}
      {% endif %}
      {% set pollutantTableE = daqi.pollutantTable.e or '' %}
      {% set row = [
        {
          html: "<a class='govuk-!-margin-bottom-1 govuk-!-font-weight-bold' href='" + pollutantHref + "'>" + pollutantTitle + "</a><span class='govuk-caption-s govuk-!-margin-bottom-1'>" + pollutantTableE + ' ' + pollutantLowRange + "</span>",
          classes: "align-middle"
        },
        {
          html: pollutantValue + " <span class='govuk-!-font-size-16 govuk-!-font-weight-regular'>μg/m<sup>3</sup></span>",
          classes: "align-middle"
        },
        {
          html: "<strong class='daqi-tag daqi-tag--" + pollutantBandClass + "'>" + pollutantBand + "</strong>",
          classes: "align-middle"
        }
      ] %}
      {% set _ = rows.push(row) %}
    {% endif %}
  {% endfor %}

  {% set tableHtml %}
    <h3 class="govuk-heading-s govuk-!-margin-bottom-1 pollutant-table">{{ site.name }}</h3>
    {# Distance text visible only on mobile devices #}
    <p class="defra-aq-tabs__mobile-distance govuk-caption-m">{{ site.distance }} {{daqi.pollutantTable.a}}</p>
    <p>{{ siteTypeDescriptions[site.areaType] }}</p>
    {{ govukTable({
        classes: "govuk-!-margin-bottom-2",
        firstCellIsHeader: false,
        head: [
          { text: daqi.pollutantTable.b },
          { html: daqi.pollutantTable.c },
          { html: daqi.pollutantTable.d }
        ],
        rows: rows
    }) }}
    {% if lang == 'cy' %}
    <p class='govuk-caption-s govuk-!-margin-bottom-6'>{{ daqi.pollutantTable.f }} {{ pollutantTime }} {{ daqi.pollutantTable.g }} {{ pollutantDay }} {{ welshMonth }} {{ pollutantYear }}</p>
    {% else %}
    <p class='govuk-caption-s govuk-!-margin-bottom-6'>{{ daqi.pollutantTable.f }} {{ pollutantTime }} {{ daqi.pollutantTable.g }} {{ pollutantDay }} {{ pollutantMonth }} {{ pollutantYear }}</p>
    {% endif %}
  {% endset %}

  {% set _ = tabs.push({
    classes: "govuk-tabs__list-item--sites",
    label: site.name | truncate(1500),
    status: "<span class='defra-aq-tabs__label-distance'>" ~ site.distance ~ " miles away</span>",
    id: "tab-" + loop.index,
    panel: {
      html: tableHtml
    }
  }) %}
{% endfor %}

{% if monitoringSites|length > 1 %}
  {# Render govukTabs with the dynamically generated tabs #}
  {{ govukTabs({
    classes: "defra-aq-tabs",
    items: tabs
  }) }}
{% elif monitoringSites|length == 1 %}
  {# Render only the govukTable for the single site #}
  {% set site = monitoringSites[0] %}
  {% set rows = [] %}
  {# Populate rows with pollutant data #}
  {% for key, pollutantDetail in pollutantTypes %}
    {% set pollutant = site.pollutants[key] %}
    {% if pollutant %}
      {# Defensive assignments for pollutant time fields #}
      {% if pollutant.time and pollutant.time.hour is defined %}
        {% set pollutantTime = pollutant.time.hour %}
      {% else %}
        {% set pollutantTime = '' %}
      {% endif %}
      {% if pollutant.time and pollutant.time.day is defined %}
        {% set pollutantDay = pollutant.time.day %}
      {% else %}
        {% set pollutantDay = '' %}
      {% endif %}
      {% if pollutant.time and pollutant.time.month is defined %}
        {% set pollutantMonth = pollutant.time.month %}
      {% else %}
        {% set pollutantMonth = '' %}
      {% endif %}
      {% if pollutant.time and pollutant.time.year is defined %}
        {% set pollutantYear = pollutant.time.year %}
      {% else %}
        {% set pollutantYear = '' %}
      {% endif %}
      {# Defensive assignments for pollutant values #}
      {% set pollutantHref = pollutantDetail.href or '#' %}
      {# '' Add query parameters for back link context #}
      {% if pollutantHref != '#' %}
        {% set pollutantHref = pollutantHref + '?lang=' + lang %}
        {% if locationId %}
          {% set pollutantHref = pollutantHref + '&locationId=' + locationId %}
          {% if locationName %}
            {% set pollutantHref = pollutantHref + '&locationName=' + (locationName | urlencode) %}
          {% endif %}
          {% if searchTerms %}
            {% set pollutantHref = pollutantHref + '&searchTerms=' + (searchTerms | urlencode) %}
          {% endif %}
        {% endif %}
      {% endif %}
      {% set pollutantTitle = pollutantDetail.title or '' %}
      {% set pollutantLowRange = pollutantDetail.low_range or '' %}
      {% if pollutant.value is defined %}
        {% set pollutantValue = "<span class=\"govuk-!-font-weight-bold\">" ~ pollutant.value ~ "</span>" | safe %}
      {% else %}
        {% set pollutantValue = '' %}
      {% endif %}
      {% if pollutant.daqi is defined %}
        {% set pollutantDaqi = pollutant.daqi %}
      {% else %}
        {% set pollutantDaqi = 'default-aqi-value' %}
      {% endif %}
      {% if pollutant.band is defined %}
        {% set pollutantBand = pollutant.band %}
        {# '' - Normalize band for CSS class (handles both English and Welsh band names) #}
        {% set pollutantBandClass = pollutant.band | normalizeBandClass %}
      {% else %}
        {% set pollutantBand = '' %}
        {% set pollutantBandClass = '' %}
      {% endif %}
      {% set pollutantTableE = daqi.pollutantTable.e or '' %}
      {% set row = [
        {
          html: "<a class=\"govuk-!-margin-bottom-1 govuk-!-font-weight-bold\" href=\"" ~ pollutantHref ~ "\">" ~ pollutantTitle ~ "</a><span class=\"govuk-caption-s govuk-!-margin-bottom-1\">" ~ pollutantTableE ~ " " ~ pollutantLowRange ~ "</span>",
          classes: "align-middle"
        },
        {
          html: pollutantValue ~ " <span class=\"govuk-!-font-size-16 govuk-!-font-weight-regular\">μg/m<sup>3</sup></span>",
          classes: "align-middle"
        },
        {
          html: "<strong class=\"daqi-tag daqi-tag--" ~ pollutantBandClass ~ "\">" ~ pollutantBand ~ "</strong>",
          classes: "align-middle"
        }
      ] %}
      {# Push the row to the rows array #}
      {% set _ = rows.push(row) %}
    {% endif %}
  {% endfor %}

  {# Generate the govukTable for the single site #}
  <h3 class="govuk-heading-s govuk-!-margin-bottom-1 pollutant-table">{{ site.name }}</h3>
  <p class="govuk-caption-m govuk-!-margin-bottom-3">{{ site.distance }} {{daqi.pollutantTable.a}}</p>
  <p>{{ siteTypeDescriptions[site.areaType] }}</p>
  {{ govukTable({
      classes: "govuk-!-margin-bottom-2",
      firstCellIsHeader: false,
      head: [
        { text: daqi.pollutantTable.b },
        { html: daqi.pollutantTable.c },
        { html: daqi.pollutantTable.d }
      ],
      rows: rows
  }) }}
  {% if lang == 'cy' %}
    <p class='govuk-caption-s govuk-!-margin-bottom-6'>{{ daqi.pollutantTable.f }} {{ pollutantTime }} {{ daqi.pollutantTable.g }} {{ pollutantDay }} {{ welshMonth }} {{ pollutantYear }}</p>
  {% else %}
    <p class='govuk-caption-s govuk-!-margin-bottom-6'>{{ daqi.pollutantTable.f }} {{ pollutantTime }} {{ daqi.pollutantTable.g }} {{ pollutantDay }} {{ pollutantMonth }} {{ pollutantYear }}</p>
  {% endif %}
{% endif %}
    </div>
  </div>
{% endblock %}

{% block bodyEnd %}
  {{ super() }}
  {# '' Inject air quality health messages from server to eliminate data duplication #}
  {# '' Process air quality data to replace {locationId} placeholder and add query params for Welsh only #}
  {# '' English controller already processes this data, so we only need to process Welsh #}
  <script>
    window.airQualityMessages = {
      {% if lang == 'cy' %}
      {# Welsh messages - map Welsh keys to English keys for JavaScript compatibility #}
      {# Process to replace {locationId} and add query params (Welsh controller doesn't do this) #}
      {% set queryParams = '' %}
      {% if searchTerms %}
        {% set queryParams = queryParams + '&searchTerms=' + (searchTerms | urlencode) %}
      {% endif %}
      {% if locationName %}
        {% set queryParams = queryParams + '&locationName=' + (locationName | urlencode) %}
      {% endif %}
      'low': {{ airQualityData.isel | dump | safe | replace('{locationId}', locationId) | replace('camau-lleihau-amlygiad/cy?lang=cy', 'camau-lleihau-amlygiad/cy?lang=cy' + queryParams) | replace('effeithiau-iechyd?lang=cy', 'effeithiau-iechyd?lang=cy' + queryParams) }},
      'moderate': {{ airQualityData.cymedrol | dump | safe | replace('{locationId}', locationId) | replace('camau-lleihau-amlygiad/cy?lang=cy', 'camau-lleihau-amlygiad/cy?lang=cy' + queryParams) | replace('effeithiau-iechyd?lang=cy', 'effeithiau-iechyd?lang=cy' + queryParams) }},
      'high': {{ airQualityData.uchel | dump | safe | replace('{locationId}', locationId) | replace('camau-lleihau-amlygiad/cy?lang=cy', 'camau-lleihau-amlygiad/cy?lang=cy' + queryParams) | replace('effeithiau-iechyd?lang=cy', 'effeithiau-iechyd?lang=cy' + queryParams) }},
      'very high': {{ airQualityData.uchelIawn | dump | safe | replace('{locationId}', locationId) | replace('camau-lleihau-amlygiad/cy?lang=cy', 'camau-lleihau-amlygiad/cy?lang=cy' + queryParams) | replace('effeithiau-iechyd?lang=cy', 'effeithiau-iechyd?lang=cy' + queryParams) }}
      {% else %}
      {# English messages - already processed by controller, just dump as-is #}
      'low': {{ airQualityData.low | dump | safe }},
      'moderate': {{ airQualityData.moderate | dump | safe }},
      'high': {{ airQualityData.high | dump | safe }},
      'very high': {{ airQualityData.veryHigh | dump | safe }}
      {% endif %}
    };
  </script>
{% endblock %}