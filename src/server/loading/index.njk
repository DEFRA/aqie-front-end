{% extends 'layouts/page.njk' %}

{% block content %}
  <div class="loading-page">
    <div class="loading-page__content">
      <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
          <div class="search-loading-spinner" aria-hidden="true"></div>
          <p class="govuk-body">Loading air quality data…</p>
        </div>
      </div>

  {% if lang == 'cy' %}
    {% set fallbackHeading = 'Nid oedd modd llwytho eich canlyniadau' %}
    {% set fallbackBody = 'Rhowch gynnig arall arni neu ddychwelyd i chwilio.' %}
    {% set fallbackCta = 'Rhowch gynnig arall arni' %}
    {% set fallbackLink = 'Yn ôl i chwilio' %}
    {% set fallbackPath = '/chwilio-lleoliad/cy' %}
  {% else %}
    {% set fallbackHeading = 'We could not load your results' %}
    {% set fallbackBody = 'Try again or return to search.' %}
    {% set fallbackCta = 'Try again' %}
    {% set fallbackLink = 'Back to search' %}
    {% set fallbackPath = '/search-location' %}
  {% endif %}

      <div id="loading-error" class="govuk-grid-row govuk-!-display-none" role="alert">
        <div class="govuk-grid-column-two-thirds">
          <h1 class="govuk-heading-l" id="loading-error-heading">{{ fallbackHeading }}</h1>
          <p class="govuk-body">{{ fallbackBody }}</p>
          <div class="govuk-button-group">
            <button type="button" class="govuk-button" data-module="govuk-button" id="loading-retry">
              {{ fallbackCta }}
            </button>
            <a class="govuk-link" id="loading-fallback" href="{{ fallbackPath }}">{{ fallbackLink }}</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# '' Keep the loader visible while the request runs #}
  <script>
    (function() {
      document.documentElement.classList.add('search-loading-init')

      const payload = {{ payload | dump | safe }}
      const lang = '{{ lang }}'
      const actionPath = lang === 'cy' ? '/lleoliad' : '/location'
      const fallbackPath = lang === 'cy' ? '/chwilio-lleoliad/cy' : '/search-location'
      const errorContainer = document.getElementById('loading-error')
      const retryButton = document.getElementById('loading-retry')
      const errorHeading = document.getElementById('loading-error-heading')

      const body = new URLSearchParams()
      if (payload && typeof payload === 'object') {
        Object.entries(payload).forEach(([key, value]) => {
          if (value !== undefined && value !== null) {
            body.append(key, value)
          }
        })
      }

      const submitFallback = () => {
        const form = document.createElement('form')
        form.method = 'POST'
        form.action = actionPath

        for (const [key, value] of body.entries()) {
          const input = document.createElement('input')
          input.type = 'hidden'
          input.name = key
          input.value = value
          form.appendChild(input)
        }

        document.body.appendChild(form)
        form.submit()
      }

      let didComplete = false
      const showError = () => {
        if (didComplete) {
          return
        }
        didComplete = true
        document.documentElement.classList.remove('search-loading-init')
        if (!errorContainer) {
          window.location.assign(fallbackPath)
          return
        }

        errorContainer.classList.remove('govuk-!-display-none')
        if (errorHeading && typeof errorHeading.focus === 'function') {
          errorHeading.setAttribute('tabindex', '-1')
          errorHeading.focus()
        }
      }

      const runLookup = () => {
        const hardTimeoutId = window.setTimeout(showError, 20000)
        const controller = window.AbortController ? new AbortController() : null
        const requestOptions = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body: body.toString(),
          credentials: 'same-origin'
        }

        if (controller) {
          requestOptions.signal = controller.signal
          window.setTimeout(() => controller.abort(), 45000)
        }

        fetch(actionPath, requestOptions)
          .then(async (response) => {
            const html = await response.text()

            if (!response.ok) {
              // '' Render server error HTML when available instead of hiding it
              if (html && html.trim()) {
                didComplete = true
                window.clearTimeout(hardTimeoutId)

                if (response.url && response.url !== window.location.href) {
                  window.location.replace(response.url)
                  return
                }

                document.open()
                document.write(html)
                document.close()
                return
              }

              throw new Error('Search lookup failed')
            }

            if (!html || !html.trim()) {
              throw new Error('Empty search response')
            }

            didComplete = true
            window.clearTimeout(hardTimeoutId)

            // '' Prefer a full navigation so app scripts re-run reliably
            if (response.url && response.url !== window.location.href) {
              window.location.replace(response.url)
              return
            }

            document.open()
            document.write(html)
            document.close()
          })
          .catch(showError)
          .finally(() => {
            window.clearTimeout(hardTimeoutId)
          })
      }

      if (retryButton) {
        retryButton.addEventListener('click', () => {
          if (errorContainer) {
            errorContainer.classList.add('govuk-!-display-none')
          }
          document.documentElement.classList.add('search-loading-init')
          submitFallback()
        })
      }

      runLookup()
    })()
  </script>
{% endblock %}
