{# '' AQC-657: Exposure reduction advice section. Rendered in different positions depending on DAQI level #}
{# '' Wrapped with stable id for dynamic reordering when active forecast tab changes #}
<div id="exposure-section" class="daqiexposure{% if needsTopMargin %} govuk-!-margin-top-6{% endif %}" data-daqi-exposure>
  {# DEBUG: Show template variables #}
  <!-- DEBUG: locationId={{ locationId }}, locationName={{ locationName }}, searchTerms={{ searchTerms }}, lang={{ lang }}, band={{ airQuality.today.band }} -->
  {# '' Select appropriate exposure HTML based on DAQI level #}
  {% if airQuality.today.band == 'low' %}
    {% set exposureContent = daqi.exposureHtmlLow %}
  {% elif airQuality.today.band == 'moderate' %}
    {% set exposureContent = daqi.exposureHtmlModerate %}
  {% elif airQuality.today.band == 'high' %}
    {% set exposureContent = daqi.exposureHtmlHigh %}
  {% elif airQuality.today.band == 'very high' %}
    {% set exposureContent = daqi.exposureHtmlVeryHigh %}
  {% else %}
    {# '' Fallback to default #}
    {% set exposureContent = daqi.exposureHtml %}
  {% endif %}
  {% if locationId %}
    {# Replace the {locationId} placeholder in the URL with the actual location ID #}
    {% set exposureContent = exposureContent | replace('{locationId}', locationId) %}
    {# Build query parameters for back link context (postcode and location name) #}
    {# Always add locationName from template context, and searchTerms if available from query #}
    {% set queryParams = '' %}
    {% if searchTerms %}
      {% set queryParams = queryParams + '&searchTerms=' + (searchTerms | urlencode) %}
    {% endif %}
    {# Always include locationName in query params for proper back link context #}
    {% if locationName %}
      {% set queryParams = queryParams + '&locationName=' + (locationName | urlencode) %}
    {% endif %}
    <!-- DEBUG: queryParams={{ queryParams }} -->
    {# Add query parameters to the URL #}
    {% if queryParams %}
      {% if lang == 'en' %}
        {% set exposureContent = exposureContent | replace('health-effects?lang=en', 'health-effects?lang=en' + queryParams) %}
        {% set exposureContent = exposureContent | replace('actions-reduce-exposure?lang=en', 'actions-reduce-exposure?lang=en' + queryParams) %}
      {% elif lang == 'cy' %}
        {% set exposureContent = exposureContent | replace('effeithiau-iechyd?lang=cy', 'effeithiau-iechyd?lang=cy' + queryParams) %}
        {% set exposureContent = exposureContent | replace('camau-lleihau-amlygiad/cy?lang=cy', 'camau-lleihau-amlygiad/cy?lang=cy' + queryParams) %}
      {% endif %}
    {% endif %}
  {% endif %}
  {{ exposureContent | safe }}
</div>
