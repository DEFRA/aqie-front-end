{# Combined numbered DAQI bar with forecast tabs '' #}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}
{# Use existing date filters from legacy forecast templates '' #}
{% if airQuality and airQuality.today %}

{# Display the predicted levels heading above the tabs if provided #}
{% if daqi.headings and daqi.headings.predictedLevels %}
  <h2 class="govuk-heading-m govuk-!-margin-bottom-4">
    {{ daqi.headings.predictedLevels }}
    <span class="govuk-visually-hidden">for the next 5 days.</span>
  </h2>
{% endif %}

{# '' First tab label is translatable via content files #}
{% set todayAbbrev = daqi.tabs.today | default('Today') %}
{# '' Get full day name for "Today" for screen readers #}
{% if lang == "en" %}
  {% set todayFull = 0 | addDaysToTodayFull %}
{% else %}
  {% set todayFull = 0 | addDaysToTodayFullWelsh %}
{% endif %}

{% macro daqiNumberedBar(value, readableBand) %}
  {% set safeValue = value | default(0) %}
  {# '' Screen reader reads: "Daily Air Quality Index, level [number], [level] pollution" #}
  {% set ariaLabel = "Daily Air Quality Index, level " + (safeValue | string) + ", " + (readableBand | default('unknown') | lower) + " pollution" %}
  <div class="daqi-numbered" role="img" aria-label="{{ ariaLabel }}">
    <div class="daqi-bar" aria-hidden="true">
      {% for i in range(1, 11) %}
        {% if i == safeValue %}
          <div class="daqi-bar-segment daqi-{{ i }} daqi-selected"><span class="daqi-number">{{ i }}</span></div>
        {% else %}
          <div class="daqi-bar-segment"><span class="daqi-number">{{ i }}</span></div>
        {% endif %}
      {% endfor %}
    </div>
    <div class="daqi-labels" aria-hidden="true">
      <span class="daqi-band daqi-band-low">{{ daqi.levels.a }}</span>
      <span class="daqi-band daqi-band-moderate" style="text-align:center">{{ daqi.levels.b }}</span>
      <span class="daqi-band daqi-band-high" style="text-align:center">{{ daqi.levels.c }}</span>
      <span class="daqi-band daqi-band-very-high">{{ daqi.levels.d }}</span>
    </div>
  </div>
{% endmacro %}

{% set todayPanel %}
  {# '' Day name heading - screen reader reads full day name, visual shows "Today" or translated version #}
  <h3 class="govuk-heading-m govuk-!-margin-bottom-4" aria-label="{{ todayFull }}">{{ todayAbbrev }}</h3>
  <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, level {{ airQuality.today.value | default(0) }}, {{ airQuality.today.readableBand | default('unknown') | lower }} pollution">{{ daqi.headings.main }}</span>
  {# '' DAQI bar with aria-label reads: "Daily Air Quality Index, level 3, low" #}
  {{ daqiNumberedBar(airQuality.today.value | default(0), airQuality.today.readableBand | default('')) }}

  {# '' Forecast text - no heading, screen reader continues reading #}
  {% set todayKey = daqi.tabs.today %}
  {% if showSummaryDate and transformedDailySummary and transformedDailySummary[todayKey] %}
    <div class="daqitab-summary govuk-!-margin-top-6">
      <p>{{ transformedDailySummary[todayKey] }}</p>
    </div>
  {% endif %}
{% endset %}

{# Build tabs with dynamic coloring using existing variables '' #}
{% set items = [] %}

{# Today tab with dynamic coloring '' #}
{% set todayTabClass = "govuk-tabs__tab daqi-tab--" + (airQuality.today.value | default(0) | string) %}
{% set _ = items.push({ 
  label: todayAbbrev, 
  id: 'today', 
  panel: { html: todayPanel },
  attributes: {
    class: todayTabClass,
    'data-daqi-value': airQuality.today.value | default(0),
    'data-daqi-band': airQuality.today.readableBand | default(''),
    'aria-label': todayFull
  }
}) %}

{# Dynamic forecast days using existing date filters and coloring '' #}
{% if airQuality.day2 %}
  {% if lang == "en" %}
    {% set day2Label = 1 | addDaysToTodayAbrev %}
    {% set day2LabelFull = 1 | addDaysToTodayFull %}
  {% else %}
    {% set day2Label = 1 | addDaysToTodayAbrevWelsh %}
    {% set day2LabelFull = 1 | addDaysToTodayFullWelsh %}
  {% endif %}
  {% set day2TabClass = "govuk-tabs__tab daqi-tab--" + (airQuality.day2.value | default(0) | string) %}
  {% set day2Panel %}
    {# '' Day name heading - screen reader reads full day name, visual shows abbreviation #}
    <h3 class="govuk-heading-m govuk-!-margin-bottom-4" aria-label="{{ day2LabelFull }}">{{ day2Label }}</h3>
    <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, level {{ airQuality.day2.value | default(0) }}, {{ airQuality.day2.readableBand | default('unknown') | lower }} pollution">{{ daqi.headings.main }}</span>
    {# '' DAQI bar with aria-label reads: "Daily Air Quality Index, level X, [band]" #}
    {{ daqiNumberedBar(airQuality.day2.value | default(0), airQuality.day2.readableBand | capitalize | default('')) }}

    {# '' Forecast text - no heading, screen reader continues reading #}
    {% if showSummaryDate and transformedDailySummary %}
      {% set todayKey = daqi.tabs.today %}
      {% for key, value in transformedDailySummary %}
        {% if key != 'issue_date' and key != 'isCurrentDate' and key != todayKey %}
          {% if not (' to ' in key) and not (' i ' in key) %}
            <div class="daqitab-summary govuk-!-margin-top-6">
              <p>{{ value }}</p>
            </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endset %}
  {% set _ = items.push({
    label: day2Label,
    id: 'day2',
    panel: { html: day2Panel },
    attributes: {
      class: day2TabClass,
      'data-daqi-value': airQuality.day2.value | default(0),
      'data-daqi-band': airQuality.day2.readableBand | default(''),
      'aria-label': day2LabelFull
    }
  }) %}
{% endif %}

{% if airQuality.day3 %}
  {% if lang == "en" %}
    {% set day3Label = 2 | addDaysToTodayAbrev %}
    {% set day3LabelFull = 2 | addDaysToTodayFull %}
  {% else %}
    {% set day3Label = 2 | addDaysToTodayAbrevWelsh %}
    {% set day3LabelFull = 2 | addDaysToTodayFullWelsh %}
  {% endif %}
  {% set day3TabClass = "govuk-tabs__tab daqi-tab--" + (airQuality.day3.value | default(0) | string) %}
  {% set day3Panel %}
    {# '' Day name heading - screen reader reads full day name, visual shows abbreviation #}
    <h3 class="govuk-heading-m govuk-!-margin-bottom-4" aria-label="{{ day3LabelFull }}">{{ day3Label }}</h3>
    <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, level {{ airQuality.day3.value | default(0) }}, {{ airQuality.day3.readableBand | default('unknown') | lower }} pollution">{{ daqi.headings.main }}</span>
    {# '' DAQI bar with aria-label reads: "Daily Air Quality Index, level X, [band]" #}
    {{ daqiNumberedBar(airQuality.day3.value | default(0), airQuality.day3.readableBand | capitalize | default('')) }}

    {# '' Forecast text - no heading, screen reader continues reading #}
    {% if showSummaryDate and transformedDailySummary %}
      {% set todayKey = daqi.tabs.today %}
      {% for key, value in transformedDailySummary %}
        {% if key != 'issue_date' and key != 'isCurrentDate' and key != todayKey %}
          {% if (' to ' in key) or (' i ' in key) %}
            <div class="daqitab-summary govuk-!-margin-top-6">
              <p>{{ value }}</p>
            </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endset %}
  {% set _ = items.push({
    label: day3Label,
    id: 'day3',
    panel: { html: day3Panel },
    attributes: {
      class: day3TabClass,
      'data-daqi-value': airQuality.day3.value | default(0),
      'data-daqi-band': airQuality.day3.readableBand | default(''),
      'aria-label': day3LabelFull
    }
  }) %}
{% endif %}

{% if airQuality.day4 %}
  {% if lang == "en" %}
    {% set day4Label = 3 | addDaysToTodayAbrev %}
    {% set day4LabelFull = 3 | addDaysToTodayFull %}
  {% else %}
    {% set day4Label = 3 | addDaysToTodayAbrevWelsh %}
    {% set day4LabelFull = 3 | addDaysToTodayFullWelsh %}
  {% endif %}
  {% set day4TabClass = "govuk-tabs__tab daqi-tab--" + (airQuality.day4.value | default(0) | string) %}
  {% set day4Panel %}
    {# '' Day name heading - screen reader reads full day name, visual shows abbreviation #}
    <h3 class="govuk-heading-m govuk-!-margin-bottom-4" aria-label="{{ day4LabelFull }}">{{ day4Label }}</h3>
    <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, level {{ airQuality.day4.value | default(0) }}, {{ airQuality.day4.readableBand | default('unknown') | lower }} pollution">{{ daqi.headings.main }}</span>
    {# '' DAQI bar with aria-label reads: "Daily Air Quality Index, level X, [band]" #}
    {{ daqiNumberedBar(airQuality.day4.value | default(0), airQuality.day4.readableBand | capitalize | default('')) }}

    {# '' Forecast text - no heading, screen reader continues reading #}
    {% if showSummaryDate and transformedDailySummary %}
      {% set todayKey = daqi.tabs.today %}
      {% for key, value in transformedDailySummary %}
        {% if key != 'issue_date' and key != 'isCurrentDate' and key != todayKey %}
          {% if (' to ' in key) or (' i ' in key) %}
            <div class="daqitab-summary govuk-!-margin-top-6">
              <p>{{ value }}</p>
            </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endset %}
  {% set _ = items.push({
    label: day4Label,
    id: 'day4',
    panel: { html: day4Panel },
    attributes: {
      class: day4TabClass,
      'data-daqi-value': airQuality.day4.value | default(0),
      'data-daqi-band': airQuality.day4.readableBand | default(''),
      'aria-label': day4LabelFull
    }
  }) %}
{% endif %}

{% if airQuality.day5 %}
  {% if lang == "en" %}
    {% set day5Label = 4 | addDaysToTodayAbrev %}
    {% set day5LabelFull = 4 | addDaysToTodayFull %}
  {% else %}
    {% set day5Label = 4 | addDaysToTodayAbrevWelsh %}
    {% set day5LabelFull = 4 | addDaysToTodayFullWelsh %}
  {% endif %}
  {% set day5TabClass = "govuk-tabs__tab daqi-tab--" + (airQuality.day5.value | default(0) | string) %}
  {% set day5Panel %}
    {# '' Day name heading - screen reader reads full day name, visual shows abbreviation #}
    <h3 class="govuk-heading-m govuk-!-margin-bottom-4" aria-label="{{ day5LabelFull }}">{{ day5Label }}</h3>
    <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, level {{ airQuality.day5.value | default(0) }}, {{ airQuality.day5.readableBand | default('unknown') | lower }} pollution">{{ daqi.headings.main }}</span>
    {# '' DAQI bar with aria-label reads: "Daily Air Quality Index, level X, [band]" #}
    {{ daqiNumberedBar(airQuality.day5.value | default(0), airQuality.day5.readableBand | capitalize | default('')) }}

    {# '' Forecast text - no heading, screen reader continues reading #}
    {% if showSummaryDate and transformedDailySummary %}
      {% set todayKey = daqi.tabs.today %}
      {% for key, value in transformedDailySummary %}
        {% if key != 'issue_date' and key != 'isCurrentDate' and key != todayKey %}
          {% if (' to ' in key) or (' i ' in key) %}
            <div class="daqitab-summary govuk-!-margin-top-6">
              <p>{{ value }}</p>
            </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endset %}
  {% set _ = items.push({
    label: day5Label,
    id: 'day5',
    panel: { html: day5Panel },
    attributes: {
      class: day5TabClass,
      'data-daqi-value': airQuality.day5.value | default(0),
      'data-daqi-band': airQuality.day5.readableBand | default(''),
      'aria-label': day5LabelFull
    }
  }) %}
{% endif %}

{{ govukTabs({ classes: 'defra-aq-tabs daqi-tabs', items: items }) }}
{% else %}
{# '' No airQuality available; skip rendering to avoid runtime errors #}
{% endif %}
