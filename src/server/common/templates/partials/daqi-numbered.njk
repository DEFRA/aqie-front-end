{# Combined numbered DAQI bar with forecast tabs '' #}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}
{# Use existing date filters from legacy forecast templates '' #}
{% if airQuality and airQuality.today %}

{# Display the predicted levels heading above the tabs if provided #}
{% if daqi.headings and daqi.headings.predictedLevels %}
  <h2 class="govuk-heading-m govuk-!-margin-bottom-4">
    {{ daqi.headings.predictedLevels }}
    <span class="govuk-visually-hidden">for the next 5 days.</span>
  </h2>
{% endif %}

{# '' First tab label is translatable via content files #}
{% set todayAbbrev = daqi.tabs.today | default('Today') %}
{# '' Get full day name for "Today" for screen readers #}
{% if lang == "en" %}
  {% set todayFull = 0 | addDaysToTodayFull %}
{% else %}
  {% set todayFull = 0 | addDaysToTodayFullWelsh %}
{% endif %}

{% macro daqiNumberedBar(value, readableBand, language) %}
  {% set safeValue = value | default(0) %}
  {# '' Screen reader reads: "Daily Air Quality Index, level [number] out of 10, [level] pollution" or Welsh equivalent #}
  {% if language == 'cy' %}
    {% set ariaLabel = "Mynegai Ansawdd Aer Dyddiol, lefel " + (safeValue | string) + " allan o 10, " + (readableBand | default('anhysbys') | lower) + " llygredd" %}
  {% else %}
    {% set ariaLabel = "Daily Air Quality Index, level " + (safeValue | string) + " out of 10, " + (readableBand | default('unknown') | lower) + " pollution" %}
  {% endif %}
  <div class="daqi-numbered" role="img" aria-label="{{ ariaLabel }}">
    <div class="daqi-bar" aria-hidden="true">
      {% for i in range(1, 11) %}
        {% if i == safeValue %}
          <div class="daqi-bar-segment daqi-{{ i }} daqi-selected"><span class="daqi-number">{{ i }}</span></div>
        {% else %}
          <div class="daqi-bar-segment"><span class="daqi-number">{{ i }}</span></div>
        {% endif %}
      {% endfor %}
    </div>
    <div class="daqi-labels" aria-hidden="true">
      <span class="daqi-band daqi-band-low">{{ daqi.levels.a }}</span>
      <span class="daqi-band daqi-band-moderate" style="text-align:center">{{ daqi.levels.b }}</span>
      <span class="daqi-band daqi-band-high" style="text-align:center">{{ daqi.levels.c }}</span>
      <span class="daqi-band daqi-band-very-high">{{ daqi.levels.d }}</span>
    </div>
  </div>
{% endmacro %}

{# '' Provide robust fallback key for today's summary (Welsh pages may have English summary body). Avoid ternary to prevent syntax issues. #}
{% if transformedDailySummary and transformedDailySummary[daqi.tabs.today] %}
  {% set excludeTodayKey = daqi.tabs.today %}
{% else %}
  {% if lang == 'cy' %}
    {% set excludeTodayKey = 'Heddiw' %}
  {% else %}
    {% set excludeTodayKey = 'Today' %}
  {% endif %}
{% endif %}
{% set todayPanel %}
  {# '' Day name heading - screen reader reads full day name, visual shows "Today" or translated version #}
  <h3 class="govuk-heading-m govuk-!-margin-bottom-4" aria-label="{{ todayFull }}">{{ todayAbbrev }}</h3>
  {% if lang == 'cy' %}
    <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, lefel {{ airQuality.today.value | default(0) }} allan o 10, {{ airQuality.today.readableBand | default('anhysbys') | lower }} llygredd">{{ daqi.headings.main }}</span>
  {% else %}
    <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, level {{ airQuality.today.value | default(0) }} out of 10, {{ airQuality.today.readableBand | default('unknown') | lower }} pollution">{{ daqi.headings.main }}</span>
  {% endif %}
  {# '' DAQI bar with aria-label reads: "Daily Air Quality Index, level [number] out of 10, [band]" or Welsh equivalent #}
  {{ daqiNumberedBar(airQuality.today.value | default(0), airQuality.today.readableBand | default(''), lang) }}

  {# '' Forecast text - no heading, screen reader continues reading #}
  {% if showSummaryDate and transformedDailySummary and transformedDailySummary[excludeTodayKey] %}
    {# '' Replace {locationId} placeholder and add query parameters for proper back link context #}
    {% set todayValue = transformedDailySummary[excludeTodayKey] %}
    {% set processedTodayValue = todayValue | replace('{locationId}', locationId) %}
    {% set queryParams = '' %}
    {% if searchTerms %}
      {% set queryParams = queryParams + '&searchTerms=' + (searchTerms | urlencode) %}
    {% endif %}
    {% if locationName %}
      {% set queryParams = queryParams + '&locationName=' + (locationName | urlencode) %}
    {% endif %}
    {% if queryParams %}
      {% if lang == 'en' %}
        {% set processedTodayValue = processedTodayValue | replace('actions-reduce-exposure?lang=en', 'actions-reduce-exposure?lang=en' + queryParams) %}
        {% set processedTodayValue = processedTodayValue | replace('health-effects?lang=en', 'health-effects?lang=en' + queryParams) %}
      {% elif lang == 'cy' %}
        {% set processedTodayValue = processedTodayValue | replace('camau-lleihau-amlygiad/cy?lang=cy', 'camau-lleihau-amlygiad/cy?lang=cy' + queryParams) %}
        {% set processedTodayValue = processedTodayValue | replace('effeithiau-iechyd?lang=cy', 'effeithiau-iechyd?lang=cy' + queryParams) %}
      {% endif %}
    {% endif %}
    <div class="daqitab-summary govuk-!-margin-top-6">
      <p>{{ processedTodayValue | safe }}</p>
    </div>
  {% endif %}
  {# '' Horizontal rule should NOT be inside tab panel per clarified requirement; removed here #}
{% endset %}

{# Build tabs with dynamic coloring using existing variables '' #}
{% set items = [] %}

{# Today tab with dynamic coloring '' #}
{% set todayTabClass = "govuk-tabs__tab daqi-tab--" + (airQuality.today.value | default(0) | string) %}
{% set _ = items.push({ 
  label: todayAbbrev, 
  id: 'today', 
  panel: { html: todayPanel },
  attributes: {
    class: todayTabClass,
    'data-daqi-value': airQuality.today.value | default(0),
    'data-daqi-band': airQuality.today.readableBand | default(''),
    'aria-label': todayAbbrev
  }
}) %}

{# Dynamic forecast days using existing date filters and coloring '' #}
{% if airQuality.day2 %}
  {% if lang == "en" %}
    {% set day2Label = 1 | addDaysToTodayAbrev %}
    {% set day2LabelFull = 1 | addDaysToTodayFull %}
  {% else %}
    {% set day2Label = 1 | addDaysToTodayAbrevWelsh %}
    {% set day2LabelFull = 1 | addDaysToTodayFullWelsh %}
  {% endif %}
  {% set day2TabClass = "govuk-tabs__tab daqi-tab--" + (airQuality.day2.value | default(0) | string) %}
  {% set day2Panel %}
    {# '' Day name heading - shows full name on mobile, abbreviated on tablet+ #}
    <h3 class="govuk-heading-m govuk-!-margin-bottom-4 daqi-day-heading" aria-label="{{ day2LabelFull }}">
      <span class="daqi-day-abbrev">{{ day2Label }}</span>
      <span class="daqi-day-full">{{ day2LabelFull }}</span>
    </h3>
    {% if lang == 'cy' %}
      <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, lefel {{ airQuality.day2.value | default(0) }} allan o 10, {{ airQuality.day2.readableBand | default('anhysbys') | lower }} llygredd">{{ daqi.headings.main }}</span>
    {% else %}
      <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, level {{ airQuality.day2.value | default(0) }} out of 10, {{ airQuality.day2.readableBand | default('unknown') | lower }} pollution">{{ daqi.headings.main }}</span>
    {% endif %}
    {# '' DAQI bar with aria-label reads: "Daily Air Quality Index, level X out of 10, [band]" or Welsh equivalent #}
    {{ daqiNumberedBar(airQuality.day2.value | default(0), airQuality.day2.readableBand | capitalize | default(''), lang) }}

    {# '' Forecast text - no heading, screen reader continues reading #}
    {% if showSummaryDate and transformedDailySummary %}
      {% for key, value in transformedDailySummary %}
        {% if key != 'issue_date' and key != 'isCurrentDate' and key != excludeTodayKey %}
          {% if not (' to ' in key) and not (' i ' in key) %}
            {# '' Replace {locationId} placeholder and add query parameters for proper back link context #}
            {% set processedValue = value | replace('{locationId}', locationId) %}
            {% set queryParams = '' %}
            {% if searchTerms %}
              {% set queryParams = queryParams + '&searchTerms=' + (searchTerms | urlencode) %}
            {% endif %}
            {% if locationName %}
              {% set queryParams = queryParams + '&locationName=' + (locationName | urlencode) %}
            {% endif %}
            {% if queryParams %}
              {% if lang == 'en' %}
                {% set processedValue = processedValue | replace('actions-reduce-exposure?lang=en', 'actions-reduce-exposure?lang=en' + queryParams) %}
                {% set processedValue = processedValue | replace('health-effects?lang=en', 'health-effects?lang=en' + queryParams) %}
              {% elif lang == 'cy' %}
                {% set processedValue = processedValue | replace('camau-lleihau-amlygiad/cy?lang=cy', 'camau-lleihau-amlygiad/cy?lang=cy' + queryParams) %}
                {% set processedValue = processedValue | replace('effeithiau-iechyd?lang=cy', 'effeithiau-iechyd?lang=cy' + queryParams) %}
              {% endif %}
            {% endif %}
            <div class="daqitab-summary govuk-!-margin-top-6">
              <p>{{ processedValue | safe }}</p>
            </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {# '' Removed per-panel HR; only Today panel shows separator per requirement #}
  {% endset %}
  {% set _ = items.push({
    label: day2Label,
    id: 'day2',
    panel: { html: day2Panel },
    attributes: {
      class: day2TabClass,
      'data-daqi-value': airQuality.day2.value | default(0),
      'data-daqi-band': airQuality.day2.readableBand | default(''),
      'aria-label': day2LabelFull
    }
  }) %}
{% endif %}

{% if airQuality.day3 %}
  {% if lang == "en" %}
    {% set day3Label = 2 | addDaysToTodayAbrev %}
    {% set day3LabelFull = 2 | addDaysToTodayFull %}
  {% else %}
    {% set day3Label = 2 | addDaysToTodayAbrevWelsh %}
    {% set day3LabelFull = 2 | addDaysToTodayFullWelsh %}
  {% endif %}
  {% set day3TabClass = "govuk-tabs__tab daqi-tab--" + (airQuality.day3.value | default(0) | string) %}
  {% set day3Panel %}
    {# '' Day name heading - shows full name on mobile, abbreviated on tablet+ #}
    <h3 class="govuk-heading-m govuk-!-margin-bottom-4 daqi-day-heading" aria-label="{{ day3LabelFull }}">
      <span class="daqi-day-abbrev">{{ day3Label }}</span>
      <span class="daqi-day-full">{{ day3LabelFull }}</span>
    </h3>
    {% if lang == 'cy' %}
      <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, lefel {{ airQuality.day3.value | default(0) }} allan o 10, {{ airQuality.day3.readableBand | default('anhysbys') | lower }} llygredd">{{ daqi.headings.main }}</span>
    {% else %}
      <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, level {{ airQuality.day3.value | default(0) }} out of 10, {{ airQuality.day3.readableBand | default('unknown') | lower }} pollution">{{ daqi.headings.main }}</span>
    {% endif %}
    {# '' DAQI bar with aria-label reads: "Daily Air Quality Index, level X out of 10, [band]" or Welsh equivalent #}
    {{ daqiNumberedBar(airQuality.day3.value | default(0), airQuality.day3.readableBand | capitalize | default(''), lang) }}

    {# '' Forecast text - no heading, screen reader continues reading #}
    {% if showSummaryDate and transformedDailySummary %}
      {% for key, value in transformedDailySummary %}
        {% if key != 'issue_date' and key != 'isCurrentDate' and key != excludeTodayKey %}
          {% if (' to ' in key) or (' i ' in key) %}
            {# '' Replace {locationId} placeholder and add query parameters for proper back link context #}
            {% set processedValue = value | replace('{locationId}', locationId) %}
            {% set queryParams = '' %}
            {% if searchTerms %}
              {% set queryParams = queryParams + '&searchTerms=' + (searchTerms | urlencode) %}
            {% endif %}
            {% if locationName %}
              {% set queryParams = queryParams + '&locationName=' + (locationName | urlencode) %}
            {% endif %}
            {% if queryParams %}
              {% if lang == 'en' %}
                {% set processedValue = processedValue | replace('actions-reduce-exposure?lang=en', 'actions-reduce-exposure?lang=en' + queryParams) %}
                {% set processedValue = processedValue | replace('health-effects?lang=en', 'health-effects?lang=en' + queryParams) %}
              {% elif lang == 'cy' %}
                {% set processedValue = processedValue | replace('camau-lleihau-amlygiad/cy?lang=cy', 'camau-lleihau-amlygiad/cy?lang=cy' + queryParams) %}
                {% set processedValue = processedValue | replace('effeithiau-iechyd?lang=cy', 'effeithiau-iechyd?lang=cy' + queryParams) %}
              {% endif %}
            {% endif %}
            <div class="daqitab-summary govuk-!-margin-top-6">
              <p>{{ processedValue | safe }}</p>
            </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {# '' Removed per-panel HR; only Today panel shows separator per requirement #}
  {% endset %}
  {% set _ = items.push({
    label: day3Label,
    id: 'day3',
    panel: { html: day3Panel },
    attributes: {
      class: day3TabClass,
      'data-daqi-value': airQuality.day3.value | default(0),
      'data-daqi-band': airQuality.day3.readableBand | default(''),
      'aria-label': day3LabelFull
    }
  }) %}
{% endif %}

{% if airQuality.day4 %}
  {% if lang == "en" %}
    {% set day4Label = 3 | addDaysToTodayAbrev %}
    {% set day4LabelFull = 3 | addDaysToTodayFull %}
  {% else %}
    {% set day4Label = 3 | addDaysToTodayAbrevWelsh %}
    {% set day4LabelFull = 3 | addDaysToTodayFullWelsh %}
  {% endif %}
  {% set day4TabClass = "govuk-tabs__tab daqi-tab--" + (airQuality.day4.value | default(0) | string) %}
  {% set day4Panel %}
    {# '' Day name heading - shows full name on mobile, abbreviated on tablet+ #}
    <h3 class="govuk-heading-m govuk-!-margin-bottom-4 daqi-day-heading" aria-label="{{ day4LabelFull }}">
      <span class="daqi-day-abbrev">{{ day4Label }}</span>
      <span class="daqi-day-full">{{ day4LabelFull }}</span>
    </h3>
    {% if lang == 'cy' %}
      <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, lefel {{ airQuality.day4.value | default(0) }} allan o 10, {{ airQuality.day4.readableBand | default('anhysbys') | lower }} llygredd">{{ daqi.headings.main }}</span>
    {% else %}
      <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, level {{ airQuality.day4.value | default(0) }} out of 10, {{ airQuality.day4.readableBand | default('unknown') | lower }} pollution">{{ daqi.headings.main }}</span>
    {% endif %}
    {# '' DAQI bar with aria-label reads: "Daily Air Quality Index, level X out of 10, [band]" or Welsh equivalent #}
    {{ daqiNumberedBar(airQuality.day4.value | default(0), airQuality.day4.readableBand | capitalize | default(''), lang) }}

    {# '' Forecast text - no heading, screen reader continues reading #}
    {% if showSummaryDate and transformedDailySummary %}
      {% for key, value in transformedDailySummary %}
        {% if key != 'issue_date' and key != 'isCurrentDate' and key != excludeTodayKey %}
          {% if (' to ' in key) or (' i ' in key) %}
            {# '' Replace {locationId} placeholder and add query parameters for proper back link context #}
            {% set processedValue = value | replace('{locationId}', locationId) %}
            {% set queryParams = '' %}
            {% if searchTerms %}
              {% set queryParams = queryParams + '&searchTerms=' + (searchTerms | urlencode) %}
            {% endif %}
            {% if locationName %}
              {% set queryParams = queryParams + '&locationName=' + (locationName | urlencode) %}
            {% endif %}
            {% if queryParams %}
              {% if lang == 'en' %}
                {% set processedValue = processedValue | replace('actions-reduce-exposure?lang=en', 'actions-reduce-exposure?lang=en' + queryParams) %}
                {% set processedValue = processedValue | replace('health-effects?lang=en', 'health-effects?lang=en' + queryParams) %}
              {% elif lang == 'cy' %}
                {% set processedValue = processedValue | replace('camau-lleihau-amlygiad/cy?lang=cy', 'camau-lleihau-amlygiad/cy?lang=cy' + queryParams) %}
                {% set processedValue = processedValue | replace('effeithiau-iechyd?lang=cy', 'effeithiau-iechyd?lang=cy' + queryParams) %}
              {% endif %}
            {% endif %}
            <div class="daqitab-summary govuk-!-margin-top-6">
              <p>{{ processedValue | safe }}</p>
            </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {# '' Removed per-panel HR; only Today panel shows separator per requirement #}
  {% endset %}
  {% set _ = items.push({
    label: day4Label,
    id: 'day4',
    panel: { html: day4Panel },
    attributes: {
      class: day4TabClass,
      'data-daqi-value': airQuality.day4.value | default(0),
      'data-daqi-band': airQuality.day4.readableBand | default(''),
      'aria-label': day4LabelFull
    }
  }) %}
{% endif %}

{% if airQuality.day5 %}
  {% if lang == "en" %}
    {% set day5Label = 4 | addDaysToTodayAbrev %}
    {% set day5LabelFull = 4 | addDaysToTodayFull %}
  {% else %}
    {% set day5Label = 4 | addDaysToTodayAbrevWelsh %}
    {% set day5LabelFull = 4 | addDaysToTodayFullWelsh %}
  {% endif %}
  {% set day5TabClass = "govuk-tabs__tab daqi-tab--" + (airQuality.day5.value | default(0) | string) %}
  {% set day5Panel %}
    {# '' Day name heading - shows full name on mobile, abbreviated on tablet+ #}
    <h3 class="govuk-heading-m govuk-!-margin-bottom-4 daqi-day-heading" aria-label="{{ day5LabelFull }}">
      <span class="daqi-day-abbrev">{{ day5Label }}</span>
      <span class="daqi-day-full">{{ day5LabelFull }}</span>
    </h3>
    {% if lang == 'cy' %}
      <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, lefel {{ airQuality.day5.value | default(0) }} allan o 10, {{ airQuality.day5.readableBand | default('anhysbys') | lower }} llygredd">{{ daqi.headings.main }}</span>
    {% else %}
      <span class="govuk-caption-s govuk-!-margin-bottom-4" aria-label="{{ daqi.headings.main }}, level {{ airQuality.day5.value | default(0) }} out of 10, {{ airQuality.day5.readableBand | default('unknown') | lower }} pollution">{{ daqi.headings.main }}</span>
    {% endif %}
    {# '' DAQI bar with aria-label reads: "Daily Air Quality Index, level X out of 10, [band]" or Welsh equivalent #}
    {{ daqiNumberedBar(airQuality.day5.value | default(0), airQuality.day5.readableBand | capitalize | default(''), lang) }}

    {# '' Forecast text - no heading, screen reader continues reading #}
    {% if showSummaryDate and transformedDailySummary %}
      {% for key, value in transformedDailySummary %}
        {% if key != 'issue_date' and key != 'isCurrentDate' and key != excludeTodayKey %}
          {% if (' to ' in key) or (' i ' in key) %}
            {# '' Replace {locationId} placeholder and add query parameters for proper back link context #}
            {% set processedValue = value | replace('{locationId}', locationId) %}
            {% set queryParams = '' %}
            {% if searchTerms %}
              {% set queryParams = queryParams + '&searchTerms=' + (searchTerms | urlencode) %}
            {% endif %}
            {% if locationName %}
              {% set queryParams = queryParams + '&locationName=' + (locationName | urlencode) %}
            {% endif %}
            {% if queryParams %}
              {% if lang == 'en' %}
                {% set processedValue = processedValue | replace('actions-reduce-exposure?lang=en', 'actions-reduce-exposure?lang=en' + queryParams) %}
                {% set processedValue = processedValue | replace('health-effects?lang=en', 'health-effects?lang=en' + queryParams) %}
              {% elif lang == 'cy' %}
                {% set processedValue = processedValue | replace('camau-lleihau-amlygiad/cy?lang=cy', 'camau-lleihau-amlygiad/cy?lang=cy' + queryParams) %}
                {% set processedValue = processedValue | replace('effeithiau-iechyd?lang=cy', 'effeithiau-iechyd?lang=cy' + queryParams) %}
              {% endif %}
            {% endif %}
            <div class="daqitab-summary govuk-!-margin-top-6">
              <p>{{ processedValue | safe }}</p>
            </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {# '' Removed per-panel HR; only Today panel shows separator per requirement #}
  {% endset %}
  {% set _ = items.push({
    label: day5Label,
    id: 'day5',
    panel: { html: day5Panel },
    attributes: {
      class: day5TabClass,
      'data-daqi-value': airQuality.day5.value | default(0),
      'data-daqi-band': airQuality.day5.readableBand | default(''),
      'aria-label': day5LabelFull
    }
  }) %}
{% endif %}

{{ govukTabs({ classes: 'defra-aq-tabs daqi-tabs', items: items }) }}
{% else %}
{# '' No airQuality available; skip rendering to avoid runtime errors #}
{% endif %}
